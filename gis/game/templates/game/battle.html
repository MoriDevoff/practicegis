{% load static %}
   {% extends 'base.html' %}
   {% block title %}GeoGame - Сражение{% endblock %}
   {% block content %}
       <h1>Сражение: {{ battle.player1.username }} vs {{ battle.player2.username|default:"Ожидает второго игрока" }}</h1>
       {% if battle.player2 %}
           <img src="{% static battle.landmark.image %}" alt="{{ battle.landmark.name }}" class="landmark-image">
           <div id="map">{{ map_html|safe }}</div>
           <button id="submit-guess">Поставить метку</button>
           <div id="result"></div>
           <input type="hidden" id="landmark-id" value="{{ battle.landmark.id }}">
           <input type="hidden" id="battle-id" value="{{ battle.id }}">
           <input type="hidden" id="user-lat" value="">
           <input type="hidden" id="user-lon" value="">
           {% if battle.winner %}
               <p>Победитель: {{ battle.winner.username }}</p>
               <p>{{ battle.player1.username }}: {{ battle.player1_score }} очков</p>
               <p>{{ battle.player2.username }}: {{ battle.player2_score }} очков</p>
           {% endif %}
       {% else %}
           <p>Ожидание второго игрока...</p>
       {% endif %}
       <script>
           document.addEventListener('click', function(e) {
               if (e.target.closest('.leaflet-popup-content')) {
                   let coords = e.target.closest('.leaflet-popup-content').innerText.split(',');
                   document.getElementById('user-lat').value = coords[0].trim();
                   document.getElementById('user-lon').value = coords[1].trim();
               }
           });

           $('#submit-guess').click(function() {
               let lat = $('#user-lat').val();
               let lon = $('#user-lon').val();
               let landmark_id = $('#landmark-id').val();
               let battle_id = $('#battle-id').val();

               if (!lat || !lon) {
                   alert('Пожалуйста, выберите точку на карте.');
                   return;
               }

               $.ajax({
                   url: '{% url "calculate_score" %}',
                   method: 'POST',
                   data: {
                       lat: lat,
                       lon: lon,
                       landmark_id: landmark_id,
                       battle_id: battle_id,
                       csrfmiddlewaretoken: '{{ csrf_token }}'
                   },
                   success: function(data) {
                       if (data.error) {
                           alert(data.error);
                       } else {
                           $('#result').html(
                               `<p>Расстояние: ${data.distance} км</p>
                               <p>Очки: ${data.score}</p>
                               <p>Правильное место: (${data.correct_lat}, ${data.correct_lon})</p>`
                           );
                           window.location.reload(); // Обновляем страницу для отображения результатов
                       }
                   },
                   error: function() {
                       alert('Ошибка при расчёте очков.');
                   }
               });
           });
       </script>
   {% endblock %}