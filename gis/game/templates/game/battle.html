{% extends 'base.html' %}
{% block title %}GeoGame - Сражение{% endblock %}
{% block content %}
<h1>Сражение</h1>
<h2>Достопримечательность: {{ landmark.name }}</h2>
{% if landmark.image %}
    <img src="{{ landmark.image.url }}" alt="{{ landmark.name }}" style="max-width: 300px;">
{% endif %}

<div id="map" style="height: 500px;"></div>

{% if not is_finished %}
    <form id="battleForm" method="post" action="{% url 'calculate_score' %}">
        {% csrf_token %}
        <input type="hidden" name="lat" id="lat" required>
        <input type="hidden" name="lon" id="lon" required>
        <input type="hidden" name="landmark_id" value="{{ landmark.id }}">
        <input type="hidden" name="battle_id" value="{{ battle.id }}">
        <button type="button" id="confirmBtn" style="margin-top: 10px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Подтвердить ответ</button>
        <div id="error-message" style="color: red; margin-top: 5px; display: none;">Пожалуйста, выберите место на карте!</div>
    </form>
{% endif %}

<div id="resultModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.3); z-index: 1000; text-align: center; width: 300px;">
    <h3 style="margin-top: 0;">Результат сражения</h3>
    <div id="battleResult"></div>
    <a href="{% url 'index' %}" class="btn" style="display: inline-block; padding: 10px 20px; background: #2196F3; color: white; text-decoration: none; border-radius: 4px; margin-top: 15px;">На главную</a>
</div>
<div id="overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;"></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    L.Icon.Default.imagePath = 'https://unpkg.com/leaflet@1.9.4/dist/images/';

    document.addEventListener('DOMContentLoaded', function() {
        var map = L.map('map').setView([{{ landmark.latitude }}, {{ landmark.longitude }}], 3);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        var userMarker = null;
        var hasAnswered = {% if player1_lat and player1_lon and request.user == battle.player1 or player2_lat and player2_lon and request.user == battle.player2 %}true{% else %}false{% endif %};
        var markers = {};
        var answerSent = false;
        var confirmed = false;
        var resultShown = false;
        var correctMarker = null;
        var wsReady = false;
        var pendingSend = null;
        var checkResultInterval = null;

        const battleSocket = new WebSocket('ws://' + window.location.host + '/ws/battle/{{ battle.id }}/');

        function showResultModal(data) {
            if (resultShown) return;
            resultShown = true;
            document.getElementById('resultModal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('battleResult').innerHTML = `
                <p>{{ battle.player1.username }}: ${data.player1_score ?? 0} очков</p>
                <p>{{ battle.player2.username }}: ${data.player2_score ?? 0} очков</p>
                ${data.player1_score > data.player2_score ? '<p><strong>Победитель: {{ battle.player1.username }}!</strong></p>' :
                  data.player2_score > data.player1_score ? '<p><strong>Победитель: {{ battle.player2.username }}!</strong></p>' :
                  '<p><strong>Ничья!</strong></p>'}
            `;
            if (correctMarker) map.removeLayer(correctMarker);
            correctMarker = L.marker([{{ landmark.latitude }}, {{ landmark.longitude }}], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map).bindPopup('Правильное место').openPopup();
            if (checkResultInterval) clearInterval(checkResultInterval);
        }

        function checkBattleResult() {
            fetch(window.location.pathname, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
                .then(response => response.json())
                .then(data => {
                    if (data.is_finished && !resultShown) {
                        showResultModal({
                            player1_score: data.player1_score ?? 0,
                            player2_score: data.player2_score ?? 0
                        });
                    }
                });
        }

        battleSocket.onopen = function() {
            console.log('Battle WebSocket connected');
            wsReady = true;
            if (pendingSend) {
                pendingSend();
                pendingSend = null;
            }
        };

        battleSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log('Battle WebSocket message:', data);
            if (data.action === 'update_markers') {
                const newMarkers = data.markers;
                for (let player in newMarkers) {
                    if (!markers[player]) {
                        let color = player === 'player1' ? 'blue' : 'red';
                        markers[player] = L.marker([newMarkers[player].lat, newMarkers[player].lon], {
                            icon: L.icon({
                                iconUrl: color === 'blue' ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png' : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                            })
                        }).addTo(map).bindPopup(`${newMarkers[player].username}: ${newMarkers[player].score} очков`);
                    } else {
                        markers[player].setLatLng([newMarkers[player].lat, newMarkers[player].lon]);
                        markers[player].setPopupContent(`${newMarkers[player].username}: ${newMarkers[player].score} очков`);
                    }
                }
            } else if (data.action === 'finish') {
                console.log('Получено событие finish:', data);
                showResultModal(data);
            }
        };

        battleSocket.onclose = function(e) {
            console.log('Battle WebSocket closed:', e);
        };

        battleSocket.onerror = function(e) {
            console.error('Battle WebSocket error:', e);
        };

        if (!hasAnswered) {
            map.on('click', function(e) {
                if (confirmed) return;
                if (userMarker) map.removeLayer(userMarker);
                var lat = e.latlng.lat;
                var lon = e.latlng.lng;
                document.getElementById('lat').value = lat;
                document.getElementById('lon').value = lon;
                userMarker = L.marker([lat, lon]).addTo(map);
            });

            document.getElementById('confirmBtn').addEventListener('click', function() {
                if (answerSent) return;
                const lat = document.getElementById('lat').value;
                const lon = document.getElementById('lon').value;
                if (!lat || !lon) {
                    document.getElementById('error-message').style.display = 'block';
                    return;
                }
                document.getElementById('error-message').style.display = 'none';
                answerSent = true;
                confirmed = true;
                document.getElementById('confirmBtn').disabled = true;
                document.getElementById('confirmBtn').style.display = 'none';
                const form = document.getElementById('battleForm');
                const formData = new FormData(form);
                function sendAnswer() {
                    fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: new URLSearchParams(formData)
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('Ошибка сервера');
                        return response.json();
                    })
                    .then(data => {
                        // Можно добавить обработку результата, если нужно
                    })
                    .catch(error => {
                        answerSent = false;
                        confirmed = false;
                        document.getElementById('confirmBtn').disabled = false;
                        document.getElementById('confirmBtn').style.display = 'block';
                        alert('Ошибка при отправке ответа: ' + error.message);
                    });
                }
                if (wsReady) {
                    sendAnswer();
                } else {
                    pendingSend = sendAnswer;
                }
                if (!checkResultInterval) {
                    checkResultInterval = setInterval(checkBattleResult, 2000);
                }
            });
        } else {
            // Если уже ответил (например, после обновления), тоже запускаем проверку
            if (!checkResultInterval) {
                checkResultInterval = setInterval(checkBattleResult, 2000);
            }
        }
    });
</script>
{% endblock %}