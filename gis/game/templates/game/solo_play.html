{% extends 'base.html' %}
{% load static %}
{% block title %}GeoGame - Одиночная игра{% endblock %}
{% block content %}
    {% if error %}
        <p>{{ error }}</p>
    {% else %}
        <h1>Одиночная игра - Угадайте место!</h1>
        <img src="{{ landmark.image.url }}" alt="{{ landmark.name }}" class="landmark-image" style="max-width: 100%;">
        <div id="map" style="height: 400px;"></div>
        <button id="submit-guess" style="display:none;">Поставить метку</button>
        <div id="result"></div>
        <input type="hidden" id="landmark-id" value="{{ landmark.id }}">
        <input type="hidden" id="landmark-lat" value="{{ landmark.latitude }}">
        <input type="hidden" id="landmark-lon" value="{{ landmark.longitude }}">
        <input type="hidden" id="user-lat" value="">
        <input type="hidden" id="user-lon" value="">
    {% endif %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            var userMarker = null;
            var roundCompleted = false;

            map.on('click', function(e) {
                if (roundCompleted) return;

                var lat = e.latlng.lat;
                var lon = e.latlng.lng;
                document.getElementById('user-lat').value = lat;
                document.getElementById('user-lon').value = lon;

                if (userMarker) {
                    map.removeLayer(userMarker);
                }
                userMarker = L.marker([lat, lon]).addTo(map).bindPopup('Ваша метка').openPopup();
                document.getElementById('submit-guess').style.display = 'block';
            });

            $('#submit-guess').click(function() {
                if (roundCompleted) return;

                let lat = $('#user-lat').val();
                let lon = $('#user-lon').val();
                let landmark_id = $('#landmark-id').val();

                if (!lat || !lon) {
                    alert('Пожалуйста, выберите точку на карте.');
                    return;
                }

                $.ajax({
                    url: '{% url "calculate_score" %}',
                    method: 'POST',
                    data: {
                        lat: lat,
                        lon: lon,
                        landmark_id: landmark_id,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function(data) {
                        if (data.error) {
                            alert(data.error);
                        } else {
                            $('#result').html(
                                `<div class="modal" id="resultModal" style="display:block; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border:1px solid black;">
                                    <p>Расстояние: ${data.distance} км</p>
                                    <p>Очки: ${data.score}</p>
                                    <p>Правильное место: (${data.correct_lat}, ${data.correct_lon})</p>
                                    <button onclick="window.location.href='{% url "index" %}'">На главную</button>
                                </div>`
                            );
                            // Отключаем карту и кнопку после завершения
                            roundCompleted = true;
                            map.off('click');
                            document.getElementById('submit-guess').style.display = 'none';
                            if (userMarker) map.removeLayer(userMarker);
                        }
                    },
                    error: function() {
                        alert('Ошибка при расчёте очков.');
                    }
                });
            });
        });
    </script>
    <style>
        .modal { z-index: 1000; }
    </style>
{% endblock %}