{% extends 'base.html' %}
{% block title %}GeoGame - Одиночная игра{% endblock %}
{% block content %}
<h1>Одиночная игра</h1>
{% if error %}
    <p>{{ error }}</p>
{% else %}
    <h2>Достопримечательность: {{ landmark.name }}</h2>
    {% if landmark.image %}
        <img src="{{ landmark.image.url }}" alt="{{ landmark.name }}" style="max-width: 300px;">
    {% endif %}

    <div id="map" style="height: 500px;"></div>

    <form id="scoreForm" method="post" action="{% url 'calculate_score' %}">
        {% csrf_token %}
        <input type="hidden" name="lat" id="lat">
        <input type="hidden" name="lon" id="lon">
        <input type="hidden" name="landmark_id" value="{{ landmark.id }}">
        <button type="button" id="confirmBtn" class="btn" style="margin-top: 10px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Подтвердить</button>
    </form>

    <div id="resultModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.3); z-index: 1000; text-align: center; width: 300px;">
        <h3 style="margin-top: 0;">Результат игры</h3>
        <p id="scoreResult" style="font-size: 18px; margin: 20px 0;"></p>
        <a href="{% url 'index' %}" class="btn" style="display: inline-block; padding: 10px 20px; background: #2196F3; color: white; text-decoration: none; border-radius: 4px;">На главную</a>
    </div>
    <div id="overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;"></div>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var map = L.map('map').setView([{{ map_center_lat }}, {{ map_center_lon }}], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

            var userMarker = null;
            var confirmed = false;

            map.on('click', function(e) {
                if (confirmed) return;

                if (userMarker) map.removeLayer(userMarker);

                var lat = e.latlng.lat;
                var lon = e.latlng.lng;
                document.getElementById('lat').value = lat;
                document.getElementById('lon').value = lon;

                userMarker = L.marker([lat, lon]).addTo(map)
                    .bindPopup('Ваш выбор')
                    .openPopup();
            });

            document.getElementById('confirmBtn').addEventListener('click', function() {
                if (!userMarker) {
                    alert('Пожалуйста, выберите место на карте!');
                    return;
                }

                fetch('{% url "calculate_score" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: new URLSearchParams(new FormData(document.getElementById('scoreForm')))
                })
                .then(response => response.json())
                .then(data => {
                    if (data.score !== undefined) {
                        confirmed = true;
                        document.getElementById('scoreResult').innerText =
                            'Вы набрали: ' + data.score + ' очков';
                        document.getElementById('resultModal').style.display = 'block';
                        document.getElementById('overlay').style.display = 'block';

                        // Показываем правильный ответ
                        L.marker([{{ landmark.latitude }}, {{ landmark.longitude }}], {
                            icon: L.icon({
                                iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-red.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34]
                            })
                        }).addTo(map).bindPopup('Правильное место').openPopup();
                    }
                });
            });
        });
    </script>
{% endif %}
{% endblock %}