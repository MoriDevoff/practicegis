{% extends 'base.html' %}
{% block title %}GeoGame - Главная{% endblock %}
{% block content %}
<h1>Добро пожаловать в GeoGame!</h1>
{% if user.is_authenticated %}
    <p>Привет, {{ user.username }}!</p>
    <form method="post" action="{% url 'online_matchmaking' %}">
        {% csrf_token %}
        <button type="submit" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Найти соперника</button>
    </form>
    <a href="{% url 'solo_play' %}" style="display: inline-block; margin-top: 10px; padding: 10px 20px; background: #2196F3; color: white; text-decoration: none; border-radius: 4px;">Играть в одиночку</a>
    <a href="{% url 'profile' %}" style="display: inline-block; margin-top: 10px; padding: 10px 20px; background: #2196F3; color: white; text-decoration: none; border-radius: 4px;">Профиль</a>
    <a href="{% url 'logout' %}" style="display: inline-block; margin-top: 10px; padding: 10px 20px; background: #F44336; color: white; text-decoration: none; border-radius: 4px;">Выйти</a>
{% else %}
    <a href="{% url 'login' %}" style="display: inline-block; margin-top: 10px; padding: 10px 20px; background: #2196F3; color: white; text-decoration: none; border-radius: 4px;">Войти</a>
    <a href="{% url 'register' %}" style="display: inline-block; margin-top: 10px; padding: 10px 20px; background: #4CAF50; color: white; text-decoration: none; border-radius: 4px;">Регистрация</a>
{% endif %}

<div id="waitingMessage" style="display: none; margin-top: 20px; color: #333;">Ожидание соперника...</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if user.is_authenticated %}
            // WebSocket для получения уведомлений о начале боя
            const matchmakingSocket = new WebSocket(
                'ws://' + window.location.host + '/ws/matchmaking/'
            );

            matchmakingSocket.onopen = function() {
                console.log('Matchmaking WebSocket connected');
            };

            matchmakingSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log('Matchmaking WebSocket message:', data);
                if (data.action === 'start') {
                    window.location.href = `/battle/${data.battle_id}/`;
                }
            };

            matchmakingSocket.onclose = function(e) {
                console.log('Matchmaking WebSocket closed:', e);
            };

            // Показываем сообщение об ожидании после отправки формы
            document.querySelector('form').addEventListener('submit', function() {
                document.getElementById('waitingMessage').style.display = 'block';
            });
        {% endif %}
    });
</script>
{% endblock %}